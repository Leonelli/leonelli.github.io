<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <title>Fridge App</title>

    <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://unpkg.com/normalize.css@8.0.0/normalize.css">
    <link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null" href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css">
</head>

<body>

    <main class="wrapper" style="padding-top:2em">

        <section class="container" id="demo-content">
            <h1 class="title">Scan barcode from Video Camera</h1>

            <p>
                <a class="button-small button-outline" href="../../index.html">HOME üè°</a>
            </p>

            <div>
                <a class="button" id="startButton">Start</a>
                <a class="button" id="resetButton">Reset</a>

                <label>
                  <input type="radio" name="opzione" id="opzione1" value="opzione1" onchange="opzioneSelezionata(this)" checked>
                  Add to Fridge
                </label>

                <label>
                  <input type="radio" name="opzione" id="opzione2" value="opzione2" onchange="opzioneSelezionata(this)">
                  Add to List
                </label>

            </div>

            <div>
                <video id="video" width="300" height="200" style="border: 1px solid gray"></video>
            </div>

            <div id="sourceSelectPanel" style="display:none">
                <label for="sourceSelect">Change video source:</label>
                <select id="sourceSelect" style="max-width:400px">
                </select>
            </div>

            <label>BarCode:</label>
            <pre><code id="result"></code></pre>
            <label>Product Name:</label>
            <pre><code id="result2"></code></pre>
            <div class="quantity-counter"><input id="quantity" type="number" min="0" max="100" value="1" class="quantity"></div>

            <a class="button" id="addButton">Add to the fridge</a>
            <br/>

            <label>Fridge:</label>
            <pre><code id="table"></code></pre>

             <label>Wish List:</label>
            <pre><code id="lista"></code></pre>



        </section>


    </main>

    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <script type="text/javascript">

        let ean_code
        let product_name
        let nutri_score
        let _quantity
        let sceltaFrigo = true;


        function opzioneSelezionata(inputRadio) {
          if (inputRadio.id === "opzione1") {
            // Aggiungi al frigorifero
            console.log("Aggiungi al frigorifero",sceltaFrigo );
              sceltaFrigo = true;

          } else if (inputRadio.id === "opzione2") {
            // Aggiungi alla lista
            console.log("Aggiungi alla lista", sceltaFrigo);
              sceltaFrigo = false;

          }
        }


        print_fridge()
        print_list()





        function setNutriScoreColor(row, nutri_score_) {
  let color;
  let textColor = "#FFF"; // default text color is white
  switch (nutri_score_.toLowerCase()) {
    case 'a':
      color = '#008B5E';
      break;
    case 'b':
      color = '#87CEEB';
      break;
    case 'c':
      color = '#FFC107';
      break;
    case 'd':
      color = '#FF8C00';
      break;
    case 'e':
      color = '#E53935';
      break;
    default:
      color = '#FFF';
      break;
  }
  let luminance = 0.2126 * parseInt(color.slice(1,3), 16) + 0.7152 * parseInt(color.slice(3,5), 16) + 0.0722 * parseInt(color.slice(5,7), 16);
  //if (luminance > 128) {
  //  textColor = "#000"; // if the background color is light, use black text
  //  color = colorDarken(color, 0.2); // make the background color slightly darker
  //} else {
    textColor = "#000"; // if the background color is dark, use white text
    color = colorLighten(color, 20); // make the background color slightly lighter
  //}
  row.style.backgroundColor = color;
  row.style.color = textColor;
}

// utility function to lighten a color by a percentage
function colorLighten(color, percent) {
    if (color !== '#FFF') {
        let num = parseInt(color.slice(1), 16);
        let amt = Math.round(2.55 * percent);
        let r = (num >> 16) + amt;
        let g = (num >> 8 & 0x00FF) + amt;
        let b = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (r < 255 ? (r < 1 ? 0 : r) : 255) * 0x10000 + (g < 255 ? (g < 1 ? 0 : g) : 255) * 0x100 + (b < 255 ? (b < 1 ? 0 : b) : 255)).toString(16).slice(1);
    }
}


       function print_list() {
           const dbName = "list_db";
           const request = indexedDB.open(dbName, 1);

           request.onupgradeneeded = function (event) {
               const db = event.target.result;
               const objectStore = db.createObjectStore("products", {keyPath: "ean"});
               objectStore.createIndex("name", "name", {unique: false});
               objectStore.createIndex("quantity", "quantity", {unique: false});
           };

           request.onsuccess = function (event) {
               const db = event.target.result;

               // Assicurati che l'object store sia stato creato con successo
               if (db.objectStoreNames.contains('products')) {

                   // Esegui la transazione con l'object store "products"
                   const transaction = db.transaction("products", "readonly");
                   const objectStore = transaction.objectStore("products");
                   const list = document.createElement("ul");

                   objectStore.openCursor().onsuccess = function (event) {
                       const cursor = event.target.result;
                       if (cursor) {
                           const productName = cursor.value.name;
                           const listItem = document.createElement("li");
                           listItem.textContent = productName + "("+cursor.value.quantity+")";
                           list.appendChild(listItem);
                           cursor.continue();
                       } else {
                           // Aggiungere la tabella alla pagina HTML
                           const resultDiv = document.getElementById("lista");
                           resultDiv.appendChild(list);
                       }
                   };
               }
           };
       }


       function print_fridge() {
    const dbName = "product_db";
    const request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = function (event) {
        const db = event.target.result;
        const objectStore = db.createObjectStore("products", { keyPath: "ean" });
        objectStore.createIndex("name", "name", { unique: false });
        objectStore.createIndex("quantity", "quantity", { unique: false });
    };

    request.onerror = function (event) {
        console.error("Errore nell'apertura del database", event);
    };

    request.onsuccess = function (event) {
        const db = event.target.result;
        console.log("Database aperto correttamente");

        // Recuperare tutti i prodotti dal database
        const transaction = db.transaction(["products"], "readwrite");
        const objectStore = transaction.objectStore("products");
        const request = objectStore.getAll();

        request.onsuccess = function (event) {
            const products = event.target.result;
            console.log(`Recuperati ${products.length} prodotti dal database`);

            /*
            // Creare una tabella HTML per visualizzare i prodotti
            const table = document.createElement("table");
            const headerRow = document.createElement("tr");
            headerRow.innerHTML = "<th>Nome</th><th>Quantit√†</th><th>Score</th><th></th>";
            table.appendChild(headerRow);

            for (const product of products) {
                if (product.quantity > 0) { // Check if quantity is greater than 0
                    const row = document.createElement("tr");
                    row.innerHTML = `<td>${product.name}</td><td>${product.quantity}</td><td>${product.nutriScore ? product.nutriScore.toUpperCase() : 'N/A'}</td><td><button onclick="decreaseQuantity('${product.ean}')">-</button></td>`;
                    table.appendChild(row);
                    setNutriScoreColor(row, product.nutriScore);

                } else { // Remove product from database if quantity is 0
                    objectStore.delete(product.ean);
                }
            }*/

            // Create a container div for the table
            const container = document.createElement("div");
            container.style.display = "flex";
            container.style.justifyContent = "center";

            // Create the table element and add it to the container
            const table = document.createElement("table");
            const headerRow = document.createElement("tr");
            headerRow.innerHTML = "<th>Nome</th><th>Quantit√†</th><th>Score</th><th></th>";
            table.appendChild(headerRow);

            // Add CSS style to center text in table cells
            const style = document.createElement('style');
            style.innerHTML = `
              td, th {
                text-align: center;
              }
            `;
            document.head.appendChild(style);

            for (const product of products) {
                if (product.quantity > 0) { // Check if quantity is greater than 0
                    const row = document.createElement("tr");
                    row.innerHTML = `<td>${product.name}</td><td>${product.quantity}</td><td>${product.nutriScore ? product.nutriScore.toUpperCase() : 'N/A'}</td><td><button onclick="decreaseQuantity('${product.ean}')">-</button></td>`;
                    table.appendChild(row);
                    setNutriScoreColor(row, product.nutriScore ? product.nutriScore.toUpperCase() : 'N/A');

                } else { // Remove product from database if quantity is 0
                    objectStore.delete(product.ean);
                }
            }

            // Add the table to the container and append the container to the document
            container.appendChild(table);
            document.body.appendChild(container);



            // Aggiungere la tabella alla pagina HTML
            const resultDiv = document.getElementById("table");
            resultDiv.innerHTML = "";
            resultDiv.appendChild(table);
        };

        request.onerror = function (event) {
            console.error("Errore nel recupero dei prodotti dal database", event);
        };
    };
}

function decreaseQuantity(ean) {
    const dbName = "product_db";
    const request = indexedDB.open(dbName, 1);

    request.onsuccess = function (event) {
        const db = event.target.result;
        console.log("Database aperto correttamente");

        const transaction = db.transaction(["products"], "readwrite");
        const objectStore = transaction.objectStore("products");
        const request = objectStore.get(ean);

        request.onsuccess = function (event) {
            const product = event.target.result;
            if (product) {
                product.quantity--;
                objectStore.put(product);
                print_fridge(); // Refresh the table to display the updated quantity
            }
        };

        request.onerror = function (event) {
            console.error("Errore nel recupero del prodotto dal database", event);
        };
    };
}


     async function identifyNutriScore(ean) {
              const url = `https://world.openfoodfacts.org/api/v0/product/${ean}.json`;
              const response = await fetch(url);
              if (response.status === 200) {
                const data = await response.json();
                const productData = data.product || {};
                console.log(productData.nutriscore_grade)
                return productData.nutriscore_grade || 'N/A';

              }
              return 'N/A';
            }


        async function identifyProduct(ean) {
          const url = `https://world.openfoodfacts.org/api/v0/product/${ean}.json`;
          const response = await fetch(url);
          if (response.status === 200) {
            const data = await response.json();
            const productData = data.product || {};
            return productData.product_name || 'N/A';
          }
          return 'N/A';
        }

        window.addEventListener('load', function () {
            document.getElementById('addButton').style.display = 'none';
            const dbName = "product_db";
            const request = indexedDB.open(dbName, 1);

            request.onupgradeneeded = function (event) {
                const db = event.target.result;
                const objectStore = db.createObjectStore("products", { keyPath: "ean" });
                objectStore.createIndex("name", "name", { unique: false });
                objectStore.createIndex("quantity", "quantity", { unique: false });
                objectStore.createIndex("nutriScore", "nutriScore", { unique: false });

            };

            const dbName2 = "list_db";
            const request2 = indexedDB.open(dbName2, 1);

            request2.onupgradeneeded = function (event) {
                const db2 = event.target.result;
                const objectStore2 = db2.createObjectStore("products", { keyPath: "ean" });
                objectStore2.createIndex("name", "name", { unique: false });
                objectStore2.createIndex("quantity", "quantity", { unique: false });
                objectStore2.createIndex("nutriScore", "nutriScore", { unique: false });
            };



            let selectedDeviceId;
            const codeReader = new ZXing.BrowserBarcodeReader()
            console.log('ZXing code reader initialized')
            codeReader.getVideoInputDevices()
                .then((videoInputDevices) => {
                    const sourceSelect = document.getElementById('sourceSelect')
                    selectedDeviceId = videoInputDevices[0].deviceId
                    if (videoInputDevices.length > 1) {
                        videoInputDevices.forEach((element) => {
                            const sourceOption = document.createElement('option')
                            sourceOption.text = element.label
                            sourceOption.value = element.deviceId
                            sourceSelect.appendChild(sourceOption)
                        })

                        sourceSelect.onchange = () => {
                            selectedDeviceId = sourceSelect.value;
                        }

                        const sourceSelectPanel = document.getElementById('sourceSelectPanel')
                        sourceSelectPanel.style.display = 'block'
                    }

                    document.getElementById('startButton').addEventListener('click', () => {
                        document.getElementById('video').style.display = 'block';

                        codeReader.decodeOnceFromVideoDevice(selectedDeviceId, 'video').then((result) => {
                            console.log(result)
                            ean_code = result.text
                            document.getElementById('result').textContent = result.text
                            identifyNutriScore(result)
                            .then(result =>{
                                nutri_score = result
                                }
                            )
                            .catch(error => {
                                console.error(error);
                              });
                            identifyProduct(result)
                              .then(result => {
                                document.getElementById("result2").textContent = result;
                                product_name=result
                              })
                              .catch(error => {
                                console.error(error);
                              });
                            // Hide the video element
                            document.getElementById('video').style.display = 'none';
                            document.getElementById('addButton').style.display = 'block';
                            document.getElementById('result').style.display = 'block';
                        document.getElementById('result2').style.display = 'block';
                        }).catch((err) => {
                            console.error(err)
                            document.getElementById('result').textContent = err
                        })
                        console.log(`Started continous decode from camera with id ${selectedDeviceId}`)

                    })


                    document.getElementById('resetButton').addEventListener('click', () => {
                        document.getElementById('result').textContent = '';
                        document.getElementById('result2').textContent = '';
                        document.getElementById('quantity').value = 1;


                        codeReader.reset();
                        console.log('Reset.')
                        print_fridge()
                        print_list();

                        document.getElementById('video').style.display = 'none';
                        document.getElementById('addButton').style.display = 'none';
                        document.getElementById('result').style.display = 'none';
                        document.getElementById('result2').style.display = 'none';

                    })



                    function createObjectStore(db) {
                          const objectStore = db.createObjectStore("products", { keyPath: "ean" });
                          objectStore.createIndex("name", "name", { unique: false });
                          objectStore.createIndex("quantity", "quantity", { unique: false });
                          objectStore.createIndex("nutriScore", "nutriScore", { unique: false });
                        }



                    document.getElementById('addButton').addEventListener('click', () => {

                        // Aprire il database
                      console.log(sceltaFrigo)
                     if (sceltaFrigo === true) {
                         const dbName = "product_db";
                         const request = indexedDB.open(dbName, 1);

                         request.onupgradeneeded = function (event) {
                             const db = event.target.result;
                             createObjectStore(db);
                         };

                         request.onsuccess = function (event) {
                             const db = event.target.result;
                             console.log("Database aperto correttamente");

                             // Verificare se il prodotto esiste gi√† nel database
                             const transaction = db.transaction(["products"], "readwrite");
                             const objectStore = transaction.objectStore("products");
                             const index = objectStore.index("name");
                             const request = index.get(product_name);

                             request.onsuccess = function (event) {
                                 const existingProduct = event.target.result;
                                 console.log(ean_code, product_name);
                                 if (existingProduct && existingProduct.ean === ean_code) {
                                     // Incrementare la quantit√† del prodotto esistente
                                     _quantity = document.getElementById("quantity").value;
                                     console.log("_quantity" + _quantity);
                                     const quantity = parseInt(_quantity);
                                     existingProduct.quantity += quantity;
                                     const request = objectStore.put(existingProduct);
                                     request.onsuccess = function (event) {
                                         console.log("Quantit√† del prodotto aggiornata correttamente nel database");
                                     };
                                     request.onerror = function (event) {
                                         console.error("Errore nell'aggiornamento della quantit√† del prodotto nel database", event);
                                     };
                                 } else {
                                     // Aggiungere un nuovo prodotto al database
                                     _quantity = document.getElementById("quantity").value;
                                     console.log("_quantity" + _quantity);
                                     const product = {
                                         ean: ean_code,
                                         name: product_name,
                                         nutriScore: nutri_score,
                                         quantity: _quantity
                                     };
                                     const request = objectStore.add(product);
                                     if (ean_code && product_name) {
                                         request.onsuccess = function (event) {
                                             console.log("Prodotto aggiunto correttamente al database");
                                         };
                                         request.onerror = function (event) {
                                             console.error("Errore nell'aggiunta del prodotto al database", event);
                                         };
                                     }
                                 }
                             };

                             request.onerror = function (event) {
                                 console.error("Errore nella verifica dell'esistenza del prodotto nel database", event);
                             };
                         };
                     }

                    else if(sceltaFrigo === false){
                         const dbName = "list_db";
                      const request = indexedDB.open(dbName, 1);

                      request.onupgradeneeded = function(event) {
                        const db = event.target.result;
                        createObjectStore(db);
                      };

                      request.onsuccess = function(event) {
                        const db = event.target.result;
                        console.log("Database aperto correttamente");

                        // Verificare se il prodotto esiste gi√† nel database
                        const transaction = db.transaction(["products"], "readwrite");
                        const objectStore = transaction.objectStore("products");
                        const index = objectStore.index("name");
                        const request = index.get(product_name);

                      request.onsuccess = function(event) {
                          const existingProduct = event.target.result;
                          console.log(ean_code,product_name);
                          if (existingProduct && existingProduct.ean === ean_code) {
                              // Incrementare la quantit√† del prodotto esistente
                              _quantity = document.getElementById("quantity").value;
                              console.log("_quantity" + _quantity);
                              const quantity = parseInt(_quantity);
                              existingProduct.quantity +=quantity;
                              const request = objectStore.put(existingProduct);
                              request.onsuccess = function (event) {
                                  console.log("Quantit√† del prodotto aggiornata correttamente nel database");
                              };
                              request.onerror = function (event) {
                                  console.error("Errore nell'aggiornamento della quantit√† del prodotto nel database", event);
                              };
                          } else {
                              // Aggiungere un nuovo prodotto al database
                               _quantity = document.getElementById("quantity").value;
                              console.log("_quantity" + _quantity);
                              const product = {ean: ean_code, name: product_name, nutriScore:nutri_score, quantity: _quantity};
                              const request = objectStore.add(product);
                              if (ean_code && product_name) {
                                  request.onsuccess = function (event) {
                                      console.log("Prodotto aggiunto correttamente al database");
                                  };
                                  request.onerror = function (event) {
                                      console.error("Errore nell'aggiunta del prodotto al database", event);
                                  };
                              }
                          }
                      };

                      request.onerror = function(event) {
                        console.error("Errore nella verifica dell'esistenza del prodotto nel database", event);
                      };
                    };
                     }


                         document.getElementById('result').textContent = '';
                        document.getElementById('result2').textContent = '';

                        codeReader.reset();
                        console.log('Reset.')

                        print_fridge()
                        print_list();
                        document.getElementById('addButton').style.display = 'none';
                        document.getElementById('video').style.display = 'none';
                        document.getElementById('result').style.display = 'none';
                        document.getElementById('result2').style.display = 'none';


                    })

                })
                .catch((err) => {
                    console.error(err)
                })
        })
    </script>

</body>

</html>
